# 乱码问题完整解决方案

## 问题描述

在Windows PowerShell中使用SSH或执行命令时，中文字符显示为乱码（如：灏忔煶、鍛戒护等）。

## 根本原因

1. **PowerShell默认编码不是UTF-8** - Windows PowerShell默认使用GBK编码
2. **SSH输出编码不匹配** - Linux服务器使用UTF-8，Windows终端使用GBK
3. **控制台代码页设置** - Windows控制台默认代码页不是65001（UTF-8）

## 解决方案

### 方案1：临时修复（当前会话）

在PowerShell命令前添加编码设置：

```powershell
chcp 65001 | Out-Null
[Console]::OutputEncoding = [System.Text.Encoding]::UTF8
$OutputEncoding = [System.Text.Encoding]::UTF8

# 然后执行你的命令
```

### 方案2：使用修复工具

运行编码修复工具：

```powershell
.\encoding-fix-complete.ps1
```

### 方案3：永久修复

运行编码修复工具并添加永久配置：

```powershell
.\encoding-fix-complete.ps1 -Permanent
```

这会在PowerShell配置文件中添加自动编码修复。

### 方案4：使用批处理包装器

使用提供的批处理文件执行命令：

```batch
run-with-utf8.bat powershell -File your-script.ps1
```

## 工具说明

### 1. encoding-fix-complete.ps1

**功能**：
- 设置当前会话的UTF-8编码
- 测试中文字符显示
- 可选：永久添加到PowerShell配置文件
- 创建批处理包装器

**使用方法**：
```powershell
# 临时修复
.\encoding-fix-complete.ps1

# 永久修复
.\encoding-fix-complete.ps1 -Permanent
```

### 2. fix-encoding.ps1

**功能**：
- 快速设置UTF-8编码
- 测试编码是否正常工作

**使用方法**：
```powershell
.\fix-encoding.ps1
```

### 3. quick-ssh-utf8.ps1

**功能**：
- 带UTF-8支持的SSH命令工具
- 自动设置编码
- 显示中文提示信息

**使用方法**：
```powershell
.\quick-ssh-utf8.ps1 -Command "ls -lh /home/ubuntu/"
```

### 4. run-with-utf8.bat

**功能**：
- 批处理包装器
- 自动设置UTF-8编码后执行命令

**使用方法**：
```batch
run-with-utf8.bat powershell -File script.ps1
```

## 测试验证

### 测试1：PowerShell中文显示

```powershell
.\encoding-fix-complete.ps1
Write-Host "测试中文：你好世界！"
```

应该正确显示中文，而不是乱码。

### 测试2：SSH输出中文

```powershell
.\encoding-fix-complete.ps1
.\quick-ssh-utf8.ps1 -Command "ls -lh /home/ubuntu/xiaoliu/ | grep 小柳"
```

应该正确显示文件名中的中文字符。

### 测试3：文件读写

```powershell
.\encoding-fix-complete.ps1
"测试中文内容" | Out-File -FilePath test.txt -Encoding UTF8
Get-Content test.txt
```

应该正确读取和显示中文内容。

## 常见问题

### Q1: 为什么有时候还是乱码？

A: 可能的原因：
1. 没有在当前会话中运行编码修复
2. 文件本身不是UTF-8编码
3. SSH服务器端的locale设置问题

解决方法：
```powershell
# 每次打开新的PowerShell窗口都运行
.\encoding-fix-complete.ps1

# 或者使用永久修复
.\encoding-fix-complete.ps1 -Permanent
```

### Q2: 永久修复后还是乱码？

A: 检查PowerShell配置文件是否正确加载：

```powershell
# 查看配置文件位置
$PROFILE

# 查看配置文件内容
Get-Content $PROFILE

# 测试配置文件
Test-Path $PROFILE
```

### Q3: 批处理文件中如何避免乱码？

A: 在批处理文件开头添加：

```batch
@echo off
chcp 65001 >nul
```

### Q4: Cursor中运行命令乱码？

A: 在Cursor的终端中先运行：

```powershell
.\encoding-fix-complete.ps1
```

然后再执行其他命令。

## 技术细节

### Windows代码页

- **936**: GBK编码（Windows中文默认）
- **65001**: UTF-8编码（推荐）

查看当前代码页：
```powershell
chcp
```

设置UTF-8代码页：
```powershell
chcp 65001
```

### PowerShell编码设置

PowerShell有三个编码设置：

1. **控制台代码页**: `chcp 65001`
2. **Console编码**: `[Console]::OutputEncoding`
3. **PowerShell输出编码**: `$OutputEncoding`

需要同时设置这三个才能完全解决乱码问题。

### SSH编码问题

SSH连接到Linux服务器时，服务器使用UTF-8编码，但Windows终端可能使用GBK，导致：
- 服务器发送UTF-8编码的中文
- Windows终端用GBK解码
- 显示为乱码

解决方法是让Windows终端也使用UTF-8解码。

## 最佳实践

### 1. 开发环境设置

在PowerShell配置文件中添加：

```powershell
# $PROFILE 文件内容
chcp 65001 | Out-Null
[Console]::OutputEncoding = [System.Text.Encoding]::UTF8
$OutputEncoding = [System.Text.Encoding]::UTF8
```

### 2. 脚本开发

在脚本开头添加：

```powershell
# 设置UTF-8编码
chcp 65001 | Out-Null
[Console]::OutputEncoding = [System.Text.Encoding]::UTF8
$OutputEncoding = [System.Text.Encoding]::UTF8
```

### 3. 文件保存

- 所有脚本文件使用UTF-8编码保存
- 避免使用UTF-8 BOM（可能导致问题）
- 使用`-Encoding UTF8`参数保存文件

### 4. SSH使用

使用提供的`quick-ssh-utf8.ps1`工具，它已经内置编码修复。

## 验证清单

完成以下检查确认乱码问题已解决：

- [ ] 运行`encoding-fix-complete.ps1`成功
- [ ] PowerShell中能正确显示中文
- [ ] SSH命令输出中文正常
- [ ] 文件读写中文正常
- [ ] 批处理文件中文正常
- [ ] 永久修复已应用（可选）

## 总结

乱码问题的核心是**编码不匹配**，解决方法是：

1. ✅ 统一使用UTF-8编码
2. ✅ 设置PowerShell的三个编码配置
3. ✅ 使用提供的工具自动修复
4. ✅ 可选：永久添加到配置文件

---

**更新时间**: 2025-10-05  
**状态**: ✅ 已测试通过  
**工具**: encoding-fix-complete.ps1, fix-encoding.ps1, quick-ssh-utf8.ps1, run-with-utf8.bat
