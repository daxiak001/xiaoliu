# 小柳云端工具包使用说明

## 📦 工具包位置

**本地**: `f:/源码文档/设置/`  
**服务器**: `/home/ubuntu/xiaoliu/tools/`

---

## 🛠️ 工具清单

### SSH连接工具（解决卡死问题）

| 工具 | 功能 | 使用场景 |
|------|------|----------|
| `fix-ssh-hang.ps1` | SSH连接修复和诊断 | 首次使用或连接有问题时 |
| `quick-ssh-v2.ps1` | 快速SSH命令执行（永不卡死） | 执行远程命令 |
| `quick-scp-v2.ps1` | 快速文件上传（永不卡死） | 上传文件到服务器 |
| `修复SSH卡死.bat` | 一键修复SSH连接 | Windows快捷启动 |
| `测试SSH连接.bat` | 测试SSH连接状态 | 验证连接是否正常 |

### 编码修复工具（解决乱码问题）

| 工具 | 功能 | 使用场景 |
|------|------|----------|
| `encoding-fix-complete.ps1` | 完整编码修复（可永久） | 解决所有中文乱码问题 |
| `fix-encoding.ps1` | 快速编码修复 | 临时修复当前会话 |
| `quick-ssh-utf8.ps1` | 带UTF-8支持的SSH工具 | SSH命令需要显示中文 |
| `run-with-utf8.bat` | UTF-8包装器 | 批处理文件中使用 |

### 文档

| 文档 | 内容 |
|------|------|
| `SSH卡死问题-最终解决方案.md` | SSH卡死问题的完整解决方案 |
| `SSH问题完整解决方案.md` | SSH问题技术说明 |
| `乱码问题完整解决方案.md` | 中文乱码问题的完整解决方案 |
| `工具包使用说明.md` | 本文档 |

---

## 🚀 快速开始

### 场景1：首次使用

```powershell
# 1. 进入工具目录
cd "f:/源码文档/设置"

# 2. 修复SSH连接
powershell -ExecutionPolicy Bypass -File "fix-ssh-hang.ps1"

# 3. 修复编码问题
powershell -ExecutionPolicy Bypass -File "encoding-fix-complete.ps1"

# 4. 测试连接
powershell -ExecutionPolicy Bypass -File "quick-ssh-v2.ps1" -Command "pwd"
```

### 场景2：执行远程命令

```powershell
# 查看目录
.\quick-ssh-v2.ps1 -Command "ls -lh /home/ubuntu/xiaoliu/"

# 查看文件内容
.\quick-ssh-v2.ps1 -Command "cat /home/ubuntu/xiaoliu/version.txt"

# 执行复杂命令
.\quick-ssh-v2.ps1 -Command "df -h && free -h"
```

### 场景3：上传文件

```powershell
# 上传单个文件
.\quick-scp-v2.ps1 -SourceFile "本地文件.txt" -TargetPath "/home/ubuntu/xiaoliu/"

# 上传到指定目录
.\quick-scp-v2.ps1 -SourceFile "文档.md" -TargetPath "/home/ubuntu/xiaoliu/rules/"
```

### 场景4：解决中文乱码

```powershell
# 临时修复（当前会话）
.\encoding-fix-complete.ps1

# 永久修复（添加到配置文件）
.\encoding-fix-complete.ps1 -Permanent
```

---

## 💡 使用技巧

### 技巧1：设置超时时间

```powershell
# SSH命令超时（默认10秒）
.\quick-ssh-v2.ps1 -Command "长时间命令" -Timeout 30

# SCP上传超时（默认30秒）
.\quick-scp-v2.ps1 -SourceFile "大文件.zip" -TargetPath "/home/ubuntu/" -Timeout 60
```

### 技巧2：批处理文件中使用

```batch
@echo off
chcp 65001 >nul
cd "f:/源码文档/设置"

REM 执行SSH命令
powershell -NoProfile -ExecutionPolicy Bypass -File "quick-ssh-v2.ps1" -Command "ls -lh /home/ubuntu/"

REM 上传文件
powershell -NoProfile -ExecutionPolicy Bypass -File "quick-scp-v2.ps1" -SourceFile "文件.txt" -TargetPath "/home/ubuntu/"
```

### 技巧3：在Cursor中使用

```powershell
# 先修复编码
.\encoding-fix-complete.ps1

# 然后执行命令
.\quick-ssh-v2.ps1 -Command "你的命令"
```

---

## ⚠️ 注意事项

### 服务器配置

```
服务器IP: 43.142.176.53
用户名: ubuntu
SSH端口: 22（默认）
API端口: 8889（HTTP访问）
密钥文件: server_key
```

### 常见错误

1. **"Key file not found"**
   - 确保在项目根目录运行
   - 或使用完整路径

2. **"Permission denied"**
   - 运行`fix-ssh-hang.ps1`修复密钥权限
   - 确认使用正确的用户名（ubuntu）

3. **命令超时**
   - 使用`-Timeout`参数增加超时时间
   - 检查网络连接

4. **中文乱码**
   - 运行`encoding-fix-complete.ps1`
   - 或使用`-Permanent`参数永久修复

---

## 🔍 故障排查

### 问题1：SSH连接失败

```powershell
# 1. 运行诊断工具
.\fix-ssh-hang.ps1

# 2. 检查网络
ping 43.142.176.53

# 3. 测试SSH
.\quick-ssh-v2.ps1 -Command "echo test"
```

### 问题2：文件上传失败

```powershell
# 1. 检查文件是否存在
Test-Path "文件路径"

# 2. 检查目标路径
.\quick-ssh-v2.ps1 -Command "ls -ld /目标路径/"

# 3. 尝试上传到/tmp/测试
.\quick-scp-v2.ps1 -SourceFile "文件" -TargetPath "/tmp/"
```

### 问题3：中文显示乱码

```powershell
# 1. 检查当前编码
chcp

# 2. 运行编码修复
.\encoding-fix-complete.ps1

# 3. 验证修复
Write-Host "测试中文：你好世界"
```

---

## 📊 性能特点

### SSH工具

- ✅ 自动超时控制（10秒默认）
- ✅ 永不卡死保证
- ✅ 清晰的成功/失败提示
- ✅ 实时输出显示

### SCP工具

- ✅ 自动超时控制（30秒默认）
- ✅ 显示文件大小
- ✅ 上传进度提示
- ✅ 错误详细信息

### 编码工具

- ✅ 一键修复所有编码问题
- ✅ 支持永久配置
- ✅ 自动测试验证
- ✅ 创建批处理包装器

---

## 🎯 最佳实践

### 1. 开发环境初始化

```powershell
# 首次使用运行
.\fix-ssh-hang.ps1
.\encoding-fix-complete.ps1 -Permanent
```

### 2. 日常使用

```powershell
# 使用quick-ssh-v2.ps1和quick-scp-v2.ps1
# 它们已经内置所有修复
```

### 3. 批量操作

```powershell
# 创建脚本文件
$files = @("file1.txt", "file2.txt", "file3.txt")
foreach ($file in $files) {
    .\quick-scp-v2.ps1 -SourceFile $file -TargetPath "/home/ubuntu/xiaoliu/"
}
```

### 4. 错误处理

```powershell
# 使用try-catch
try {
    .\quick-ssh-v2.ps1 -Command "你的命令"
    if ($LASTEXITCODE -ne 0) {
        Write-Host "命令执行失败"
    }
} catch {
    Write-Host "发生错误: $_"
}
```

---

## 📝 更新日志

### 2025-10-05

**SSH工具**:
- ✅ 创建fix-ssh-hang.ps1 - SSH修复工具
- ✅ 创建quick-ssh-v2.ps1 - 快速SSH命令工具
- ✅ 创建quick-scp-v2.ps1 - 快速SCP上传工具
- ✅ 解决SSH命令卡死问题
- ✅ 添加超时控制
- ✅ 修复密钥权限问题

**编码工具**:
- ✅ 创建encoding-fix-complete.ps1 - 完整编码修复
- ✅ 创建fix-encoding.ps1 - 快速编码修复
- ✅ 创建quick-ssh-utf8.ps1 - UTF-8 SSH工具
- ✅ 创建run-with-utf8.bat - UTF-8包装器
- ✅ 解决中文乱码问题
- ✅ 支持永久配置

**文档**:
- ✅ SSH卡死问题-最终解决方案.md
- ✅ 乱码问题完整解决方案.md
- ✅ 工具包使用说明.md

**部署**:
- ✅ 所有工具已上传到服务器
- ✅ 位置: /home/ubuntu/xiaoliu/tools/

---

## 🎉 总结

这个工具包彻底解决了两个主要问题：

1. **SSH命令卡死** - 使用PowerShell Job和超时控制
2. **中文乱码** - 统一使用UTF-8编码

所有工具都经过测试，可以放心使用！

---

**维护者**: 小柳云端系统  
**更新时间**: 2025-10-05  
**状态**: ✅ 生产就绪
