"""
å°æŸ³å‡çº§ï¼šCursorä¸Šä¸‹æ–‡ç®¡ç†ä¼˜åŒ–å™¨
è§£å†³é—®é¢˜53ï¼šé˜²æ­¢Cursorå¤±å¿†ï¼Œä¼˜åŒ–å¯¹è¯ç­–ç•¥
"""

class CursorContextOptimizer:
    """Cursorä¸Šä¸‹æ–‡ä¼˜åŒ–å™¨"""
    
    CONTEXT_LIMITS = {
        "Claude Sonnet 4": 200000,  # tokens
        "safe_threshold": 150000,   # å®‰å…¨é˜ˆå€¼
        "warning_threshold": 100000  # è­¦å‘Šé˜ˆå€¼
    }
    
    def __init__(self):
        self.critical_info = []  # å…³é”®ä¿¡æ¯
        self.current_tokens = 0
    
    def optimize_conversation_strategy(self):
        """ä¼˜åŒ–å¯¹è¯ç­–ç•¥"""
        return {
            "ç­–ç•¥1_å…³é”®ä¿¡æ¯æå‰": {
                "é—®é¢˜": "Cursorå¯¹è¯å¤ªé•¿ä¼šå¿˜è®°å‰é¢çš„å†…å®¹",
                "è§£å†³æ–¹æ¡ˆ": "æ¯æ¬¡å›å¤å‰å…ˆè¯»å–å…³é”®æ–‡ä»¶",
                "å®æ–½": """
# âŒ é”™è¯¯åšæ³•
ç”¨æˆ·: ä¿®æ”¹ç”¨æˆ·æ¨¡å—
Cursor: å¥½çš„ (å¯èƒ½å·²å¿˜è®°é¡¹ç›®ç”¨çš„æ˜¯Django)

# âœ… æ­£ç¡®åšæ³•
ç”¨æˆ·: ä¿®æ”¹ç”¨æˆ·æ¨¡å—
Cursor: 
  1. å…ˆè¯»å– å¿«é€Ÿå¯¼èˆª.md (ç¡®è®¤æŠ€æœ¯æ ˆ)
  2. å…ˆè¯»å– ç”¨æˆ·æ¨¡å—ç›¸å…³æ–‡ä»¶
  3. å†å¼€å§‹ä¿®æ”¹
                """,
                "User Ruleså»ºè®®": """
BEFORE every response:
1. Read D:/è®¾ç½®/ğŸ“‹ å¿…è¯»è¦æ±‚æ–‡æ¡£/å¿«é€Ÿå¯¼èˆª.md
2. Read relevant context files
3. Then respond
                """
            },
            
            "ç­–ç•¥2_åˆ†æ®µå¯¹è¯": {
                "é—®é¢˜": "ä¸€ä¸ªçª—å£å¯¹è¯å¤ªé•¿",
                "è§£å†³æ–¹æ¡ˆ": "é‡è¦èŠ‚ç‚¹å¼€æ–°çª—å£ï¼Œä¼ é€’å…³é”®ä¿¡æ¯",
                "å®æ–½": """
# å¯¹è¯èŠ‚ç‚¹1 (çª—å£1): æ¶æ„è®¾è®¡
  â†’ å®Œæˆåæ€»ç»“å…³é”®å†³ç­–åˆ° é¡¹ç›®å†³ç­–.md

# å¯¹è¯èŠ‚ç‚¹2 (çª—å£2): åŠŸèƒ½å¼€å‘
  â†’ å…ˆè¯» é¡¹ç›®å†³ç­–.md
  â†’ å†å¼€å§‹å¼€å‘
                """,
                "è§¦å‘æ¡ä»¶": [
                    "å¯¹è¯è¶…è¿‡20è½®",
                    "åˆ‡æ¢å¤§çš„åŠŸèƒ½æ¨¡å—",
                    "Cursorå¼€å§‹é—å¿˜"
                ]
            },
            
            "ç­–ç•¥3_å…³é”®ä¿¡æ¯å›ºåŒ–": {
                "é—®é¢˜": "é‡è¦å†³ç­–åœ¨å¯¹è¯ä¸­ï¼Œå®¹æ˜“ä¸¢å¤±",
                "è§£å†³æ–¹æ¡ˆ": "ç«‹å³å†™å…¥æ–‡ä»¶ï¼Œä¸ä¾èµ–å¯¹è¯è®°å¿†",
                "å…³é”®ä¿¡æ¯ç±»å‹": {
                    "æŠ€æœ¯æ ˆé€‰æ‹©": "å†™å…¥ tech-stack.md",
                    "æ¶æ„å†³ç­–": "å†™å…¥ architecture.md",
                    "ç¼–ç è§„èŒƒ": "å†™å…¥ coding-standard.md",
                    "å·²å¼€å‘åŠŸèƒ½": "å†™å…¥ å¿«é€Ÿå¯¼èˆª.md"
                },
                "User Rules": """
When user makes important decision:
  MUST immediately write to corresponding file
  DON'T rely on conversation memory
                """
            },
            
            "ç­–ç•¥4_å®šæœŸåˆ·æ–°ä¸Šä¸‹æ–‡": {
                "é—®é¢˜": "é•¿å¯¹è¯ä¸­Cursoræ¸è¿›å¼é—å¿˜",
                "è§£å†³æ–¹æ¡ˆ": "æ¯10è½®ä¸»åŠ¨é‡æ–°åŠ è½½å…³é”®ä¿¡æ¯",
                "å®æ–½": """
# å¯¹è¯ç¬¬10è½®
Cursorè‡ªåŠ¨: è®©æˆ‘å…ˆåˆ·æ–°ä¸€ä¸‹å…³é”®ä¿¡æ¯
  â†’ é‡æ–°è¯»å– å¿«é€Ÿå¯¼èˆª.md
  â†’ é‡æ–°è¯»å– å½“å‰åŠŸèƒ½ç›¸å…³æ–‡ä»¶
  â†’ ç»§ç»­å¯¹è¯

# å¯¹è¯ç¬¬20è½®
Cursorè‡ªåŠ¨: å†æ¬¡åˆ·æ–°å…³é”®ä¿¡æ¯...
                """,
                "User Rules": """
Every 10 conversation turns:
  Automatically refresh key context
  Re-read navigation and current module files
                """
            },
            
            "ç­–ç•¥5_ä¸Šä¸‹æ–‡å‹ç¼©": {
                "é—®é¢˜": "æ–‡ä»¶å¤ªå¤šï¼Œä¸Šä¸‹æ–‡çˆ†ç‚¸",
                "è§£å†³æ–¹æ¡ˆ": "åªè¯»å¿…è¦éƒ¨åˆ†ï¼Œç”¨æ‘˜è¦ä»£æ›¿å…¨æ–‡",
                "æŠ€å·§": {
                    "å¤§æ–‡ä»¶": "ç”¨offset+limitåªè¯»ç›¸å…³å‡½æ•°",
                    "é…ç½®æ–‡ä»¶": "åªè¯»æ‘˜è¦ï¼Œéœ€è¦æ—¶å†è¯»è¯¦æƒ…",
                    "æµ‹è¯•æ–‡ä»¶": "ä¸è¯»ï¼Œåªåœ¨å†™æµ‹è¯•æ—¶è¯»"
                },
                "ç¤ºä¾‹": """
# âŒ é”™è¯¯: ä¸€æ¬¡è¯»10ä¸ªæ–‡ä»¶
read_file("user.py")
read_file("order.py")
...  # ä¸Šä¸‹æ–‡çˆ†ç‚¸

# âœ… æ­£ç¡®: å…ˆæœç´¢å®šä½ï¼Œå†ç²¾å‡†è¯»å–
codebase_search("ç”¨æˆ·è®¤è¯é€»è¾‘åœ¨å“ª")
read_file("user.py", offset=50, limit=30)  # åªè¯»ç›¸å…³éƒ¨åˆ†
                """
            }
        }
    
    def detect_context_overflow_risk(self, conversation_length):
        """æ£€æµ‹ä¸Šä¸‹æ–‡æº¢å‡ºé£é™©"""
        if conversation_length > 20:
            return {
                "risk": "é«˜",
                "warning": "âš ï¸ å¯¹è¯è¿‡é•¿ï¼ŒCursorå¯èƒ½å¼€å§‹é—å¿˜",
                "actions": [
                    "1. ç«‹å³ä¿å­˜å…³é”®ä¿¡æ¯åˆ°æ–‡ä»¶",
                    "2. è€ƒè™‘å¼€æ–°çª—å£ç»§ç»­",
                    "3. æˆ–è¦æ±‚Cursoré‡æ–°åŠ è½½å…³é”®ä¸Šä¸‹æ–‡"
                ]
            }
        elif conversation_length > 10:
            return {
                "risk": "ä¸­",
                "warning": "æç¤ºCursoråˆ·æ–°å…³é”®ä¿¡æ¯",
                "actions": ["è¦æ±‚é‡æ–°è¯»å–å¿«é€Ÿå¯¼èˆª"]
            }
        else:
            return {"risk": "ä½"}
    
    def generate_context_refresh_prompt(self):
        """ç”Ÿæˆä¸Šä¸‹æ–‡åˆ·æ–°æç¤ºè¯"""
        return """
ğŸ”„ ä¸Šä¸‹æ–‡åˆ·æ–°æ£€æŸ¥ç‚¹

åœ¨ç»§ç»­ä¹‹å‰ï¼Œè¯·å…ˆ:
1. é‡æ–°è¯»å– D:/è®¾ç½®/ğŸ“‹ å¿…è¯»è¦æ±‚æ–‡æ¡£/å¿«é€Ÿå¯¼èˆª.md
2. é‡æ–°è¯»å–å½“å‰æ­£åœ¨å¼€å‘çš„æ¨¡å—ç›¸å…³æ–‡ä»¶
3. ç¡®è®¤ä½ è®°å¾—:
   - é¡¹ç›®ä½¿ç”¨çš„æŠ€æœ¯æ ˆ
   - å½“å‰ä»»åŠ¡çš„ç›®æ ‡
   - å·²å®Œæˆçš„åŠŸèƒ½åˆ—è¡¨
   
ç¡®è®¤å®Œæˆåï¼Œç»§ç»­æˆ‘ä»¬çš„å¯¹è¯ã€‚
        """
    
    def best_practices_for_long_conversation(self):
        """é•¿å¯¹è¯æœ€ä½³å®è·µ"""
        return {
            "ç”¨æˆ·ä¾§": {
                "1. åŠæ—¶æ€»ç»“": "æ¯å®Œæˆä¸€ä¸ªåŠŸèƒ½ï¼Œè¦æ±‚Cursoræ›´æ–°å¿«é€Ÿå¯¼èˆª",
                "2. ä¸»åŠ¨åˆ·æ–°": "æ„Ÿè§‰Cursoré—å¿˜æ—¶ï¼Œè¦æ±‚å®ƒé‡æ–°è¯»å–å…³é”®æ–‡ä»¶",
                "3. å¼€æ–°çª—å£": "å¤§åŠŸèƒ½åˆ‡æ¢æ—¶ï¼Œå¼€æ–°çª—å£å¹¶ä¼ é€’ä¸Šä¸‹æ–‡",
                "4. ç®€åŒ–æè¿°": "ä¸è¦åœ¨å¯¹è¯ä¸­æ”¾å¤§é‡ä»£ç ï¼Œç”¨æ–‡ä»¶ä»£æ›¿"
            },
            "Cursorä¾§": {
                "1. è‡ªåŠ¨ä¿å­˜": "é‡è¦ä¿¡æ¯ç«‹å³å†™æ–‡ä»¶",
                "2. å®šæœŸåˆ·æ–°": "æ¯10è½®è‡ªåŠ¨é‡æ–°åŠ è½½",
                "3. æŒ‰éœ€è¯»å–": "ä¸è¦ä¸€æ¬¡è¯»å¤ªå¤šæ–‡ä»¶",
                "4. å…³é”®ä¿¡æ¯å‰ç½®": "æ¯æ¬¡å›å¤å‰å…ˆç¡®è®¤æŠ€æœ¯æ ˆ"
            }
        }

# ä½¿ç”¨ç¤ºä¾‹
if __name__ == "__main__":
    optimizer = CursorContextOptimizer()
    
    # æ£€æµ‹é£é™©
    risk = optimizer.detect_context_overflow_risk(conversation_length=15)
    print(f"ä¸Šä¸‹æ–‡é£é™©: {risk['risk']}")
    
    # è·å–ä¼˜åŒ–ç­–ç•¥
    strategies = optimizer.optimize_conversation_strategy()
    print("\nä¼˜åŒ–ç­–ç•¥:")
    for name, strategy in strategies.items():
        print(f"\n{name}:")
        print(f"  é—®é¢˜: {strategy['é—®é¢˜']}")
        print(f"  è§£å†³: {strategy['è§£å†³æ–¹æ¡ˆ']}")
    
    # ç”Ÿæˆåˆ·æ–°æç¤º
    if risk['risk'] == 'é«˜':
        print("\n" + optimizer.generate_context_refresh_prompt())

